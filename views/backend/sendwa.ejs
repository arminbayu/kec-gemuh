<% layout('layout') -%>
    <div class="container">
        <div class="panel-header bg-primary-gradient">
            <div class="page-inner py-5">
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row">
                    <div>
                        <h2 class="text-white pb-2 fw-bold">Send Message</h2>
                        <h5 class="text-white op-7 mb-2">Testing API Send Whatsapp Message</h5>
                    </div>

                </div>
            </div>
        </div>
        <div class="page-inner mt--5">
            <div class="row mt--2">

                <div class="col-md-6">
                    <div class="card full-height">
                        <div class="card-body">
                            <div class="card-title">Form Send Whats Up Text Only</div>
                            <div class="">
                                <div class="form-group">
                                    <label for="exampleInputEmail1">Pengirim</label>
                                    <select class="form-control data-sender" id="sender" name="sender">
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="exampleInputEmail1">Number Handphone</label>
                                    <input type="number" class="form-control" id="number" name="number"
                                        placeholder="082165561175">
                                </div>
                                <div class="form-group">
                                    <label for="exampleInputPassword1">Text Message</label>
                                    <textarea class="form-control" name="message" id="message"></textarea>
                                </div>
                                <div class="form-check">
                                    <button id="btnSave" class="btn btn-primary">Kirim</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card full-height">
                        <div class="card-body">
                            <div class="card-title">Form Send Whats Up Media</div>
                            <div class="">
                                <form method="POST" id="myFormMedia" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label for="exampleInputEmail1">Sender</label>
                                        <select class="form-control data-sender" id="sender_media" name="sender">

                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="exampleInputEmail1">Number Handphone</label>
                                        <input type="number" class="form-control" id="number_media" name="number"
                                           placeholder="082xxx">
                                    </div>
                                    <div class="form-group">
                                        <label for="exampleInputPassword1">Text Message</label>
                                        <textarea class="form-control" name="message"
                                            id="message"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="exampleInputEmail1">File</label>
                                        <input type="file" class="form-control" id="file" name="file">
                                    </div>
                                    <div class="form-check">
                                        <button type="submit" class="btn btn-primary" id="btnSubmit">Kirim</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.js" type="text/javascript"></script>
    <script type="text/javascript">
        $.ajax({
            type: 'GET',
            url: '/sendwa/listSender',
            dataType: 'json',
            success: function (d) {
                var newOptions = {};
                newOptions['-- Pilih --'] = '';
                console.log(d.data);
                for (var index = 0; index < d.data.length; index++) {
                    var option = d.data[index].phoneNumber;
                    var value = d.data[index].id;
                    newOptions[option] = value;
                }
                var $el = $(".form-control.data-sender");

                $.each(newOptions, function (key, value) {
                    $el.append($("<option></option>")
                        .attr("value", value).text(key));
                });

            }, error: function () {
                // console.log(d);
            }
        });

        $('#btnSave').click(function () {
            var formData = new FormData();

            var formData = {
                number: $("#number").val(),
                message: $("#message").val(),
            }
            
            $('#btnSave').prop('disabled', true);
            $.ajax({
                type: "POST",
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", $("#sender").val());
                },
                contentType: "application/json",
                url: '/api-v1/send-message',
                data: JSON.stringify(formData),
                dataType: 'json',
                success: function (response) {
                    if (response.status == 200) {
                        $('#btnSave').prop('disabled', false);
                        Swal.fire('Success!', 'Succes Send Message', 'success');
                    } else if (response.status == 201) {
                        $('#btnSave').prop('disabled', false);
                        Swal.fire('Warning!', response.message, 'warning');
                    } else if (response.status == 202) {
                        $('#btnSave').prop('disabled', false);
                        const array1 = response.message;
                        Swal.fire('Warning!', 'Field is required', 'warning');
                    }
                },
                error: function () {
                    $('#btnSave').prop('disabled', false);
                    Swal.fire('Failed!', 'Failed Send Message.', 'error');
                }
            });
        });

        $("#btnSubmit").click(function (event) {
            event.preventDefault();

            var form = $('#myFormMedia')[0];
            var data = new FormData(form);

            $('#btnSubmit').prop('disabled', true);

            $.ajax({
                type: "POST",
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", $("#sender_media").val());
                },
                enctype: 'multipart/form-data',
                url: '/api-v1/send-media',
                data: data,
                processData: false,
                contentType: false,
                cache: false,
                timeout: 800000,
                success: function (response) {
                    console.log(response);
                    if (response.status == 200) {
                        $('#btnSubmit').prop('disabled', false);
                        Swal.fire('Success!', 'Succes Send Message', 'success');
                    } else if (response.status == 201) {
                        $('#btnSubmit').prop('disabled', false);
                        // const array1 = response.message;
                        Swal.fire('Warning!', 'The number is not registered', 'warning');
                    } else if (response.status == 202) {
                        $('#btnSubmit').prop('disabled', false);
                        // const array1 = response.message;
                        Swal.fire('Warning!', 'Field is required', 'warning');
                    } else if (response.status == 400) {
                        $('#btnSubmit').prop('disabled', false);
                        Swal.fire('Warning!', 'No files were uploaded.', 'warning');
                    } else if (response.status == 422) {
                        $('#btnSubmit').prop('disabled', false);
                        Swal.fire('Warning!', 'Auth Not Found Please Create Account Whats Up And Scan Barcode', 'warning');
                    } else if (response.status == 500) {
                        $('#btnSubmit').prop('disabled', false);
                        Swal.fire('Failed!', 'Failed Send Message', 'error');
                    }
                },
                error: function () {
                    $('#btnSubmit').prop('disabled', false);
                    Swal.fire('Failed!', 'Failed Send Message.', 'error');
                }
            });
        });
    </script>